"""
ì¦ìƒë³„ ì§„ë£Œê³¼ ë¼ìš°íŒ… + ì‘ê¸‰ë„ í‰ê°€ ì‹œìŠ¤í…œ
ê· í˜•ì¡íŒ ë²„ì „: ìê°€ê´€ì°° 45% / ì™¸ë˜ì§„ë£Œ 45% / ì‘ê¸‰ì‹¤ 10%
"""

from typing import Dict, List, Any


# ==========================================
# 1. ì§„ë£Œê³¼ë³„ í‚¤ì›Œë“œ ë§¤í•‘
# ==========================================

DEPARTMENT_KEYWORDS: Dict[str, List[str]] = {
    # ì†Œì•„ì²­ì†Œë…„ê³¼ (ìµœìš°ì„ )
    "ì†Œì•„ì²­ì†Œë…„ê³¼": [
        "ì•„ì´", "ì•„ê¸°", "ì†Œì•„", "ì–´ë¦°ì´", "ìœ ì•„", "ì‹ ìƒì•„", "ì˜ì•„",
        "ìƒí›„", "ê°œì›”", "ëŒ", "ë¯¸ì·¨í•™", "ì´ˆë“±í•™ìƒ",
        "ì—´", "ê³ ì—´", "ë°œì—´", "ê°ê¸°", "ì½§ë¬¼", "ê¸°ì¹¨",
        "êµ¬í† ", "ì„¤ì‚¬", "ì—´ì´ ì•ˆ ë–¨ì–´", "ê²½ë ¨", "ë°œì§„",
        "ì˜ˆë°©ì ‘ì¢…", "ì„±ì¥", "ë°œë‹¬",
    ],

    # ì•ˆê³¼
    "ì•ˆê³¼": [
        "ëˆˆ", "ì‹œë ¥", "ì‹œì•¼", "ì¶©í˜ˆ", "ëˆˆë¬¼", "ëˆˆê³±", "ë‹¤ë˜ë¼",
        "ëˆˆêº¼í’€", "ëˆˆë¶€ì‹¬", "ì´ë¬¼ê°", "ëˆˆì´ ë”°ê°‘", "ëˆˆì´ ì•„í”„",
        "ê²°ë§‰ì—¼", "ê°ë§‰", "ì‹œì•¼ íë¦¼",
    ],

    # ì´ë¹„ì¸í›„ê³¼
    "ì´ë¹„ì¸í›„ê³¼": [
        "ì½”ë§‰í˜", "ì½§ë¬¼", "ë¹„ì—¼", "ì¶•ë†ì¦", "ì½”í”¼",
        "ê·€í†µì¦", "ê·€ê°€ ì•„í”„", "ì´ëª…", "ì¤‘ì´ì—¼", "ë‚œì²­",
        "ëª©ì•„í””", "ëª©ì´ ì•„í”„", "ì¸í›„í†µ", "í¸ë„", "ì‰°ëª©ì†Œë¦¬",
        "ëª©ì´ ë”°ê°‘", "ëª©ì´ ë¶“", "ì¹¨ ì‚¼í‚¤ê¸° í˜ë“¤",
    ],

    # í˜¸í¡ê¸°ë‚´ê³¼
    "í˜¸í¡ê¸°ë‚´ê³¼": [
        "ê¸°ì¹¨", "ê°€ë˜", "ìˆ¨ì´ ì°¬", "í˜¸í¡ê³¤ë€", "ìˆ¨ì‰¬ê¸° í˜ë“¤",
        "ìŒ•ìŒ•", "ì²œì‹", "íë ´", "ê°€ìŠ´ì´ ë‹µë‹µ", "ê¸°ê´€ì§€ì—¼",
    ],

    # ìˆœí™˜ê¸°ë‚´ê³¼ (ì‹¬ì¥/í˜ˆê´€)
    "ìˆœí™˜ê¸°ë‚´ê³¼": [
        "ê°€ìŠ´í†µì¦", "ì‹¬ì¥", "ë‘ê·¼ê±°ë¦¼", "ë¶€ì •ë§¥",
        "ê°€ìŠ´ì´ ì¥ì–´ì§œ", "ì¡°ì´ëŠ” ëŠë‚Œ",
        "í˜ˆì••", "ê³ í˜ˆì••", "ì €í˜ˆì••", "ë‹¤ë¦¬ ë¶€ì¢…",
    ],

    # ì†Œí™”ê¸°ë‚´ê³¼
    "ì†Œí™”ê¸°ë‚´ê³¼": [
        "ì†ì“°ë¦¼", "ëª…ì¹˜í†µì¦", "ì†Œí™”ë¶ˆëŸ‰", "ì²´í•œ",
        "êµ¬ì—­", "êµ¬í† ", "ë³µí†µ", "ë°°ì•„í””", "ë°° í†µì¦",
        "ë³€ë¹„", "ì„¤ì‚¬", "í˜ˆë³€", "ê²€ì€ ë³€", "ì†ì´ ë”ë¶€ë£©",
        "ìœ„ì—¼", "ì¥ì—¼",
    ],

    # ì •í˜•ì™¸ê³¼
    "ì •í˜•ì™¸ê³¼": [
        "ê³¨ì ˆ", "ë¶€ëŸ¬ì¡Œ", "ì‚ì—ˆ", "ì‚ë—", "ì—¼ì¢Œ",
        "ê´€ì ˆí†µ", "ë¬´ë¦", "ë°œëª©", "í—ˆë¦¬í†µì¦", "í—ˆë¦¬ê°€ ì•„í”„",
        "ëª©ë””ìŠ¤í¬", "ì–´ê¹¨í†µì¦", "ê·¼ìœ¡í†µ", "íƒ€ë°•ìƒ",
        "ë„˜ì–´ì ¸ì„œ", "ë¶€ë”ªí˜”",
    ],

    # ì‹ ê²½ê³¼/ì‹ ê²½ì™¸ê³¼
    "ì‹ ê²½ê³¼": [
        "ë‘í†µ", "í¸ë‘í†µ", "ì–´ì§€ëŸ¼", "ì–´ì§€ëŸ¬ì›€", "ì‹¤ì‹ ",
        "ë§ˆë¹„", "í˜ì´ ì•ˆ", "ê°ê° ë‘”í•¨", "ì†ë°œì €ë¦¼",
        "ë§ì´ ì–´ëˆŒ", "ë°œìŒ ì–´ëˆŒ", "ì‹œì•¼ì¥ì• ",
        "ê²½ë ¨", "ë°œì‘", "ë–¨ë¦¼", "ì˜ì‹ ì €í•˜",
    ],

    # ì‚°ë¶€ì¸ê³¼
    "ì‚°ë¶€ì¸ê³¼": [
        "ìƒë¦¬í†µ", "ìƒë¦¬ë¶ˆìˆœ", "ì§ˆì¶œí˜ˆ", "ë¶ˆê·œì¹™í•œ ìƒë¦¬",
        "ì§ˆë¶„ë¹„ë¬¼", "ëƒ‰", "ê³¨ë°˜í†µ", "í•˜ë³µë¶€í†µì¦",
        "ì„ì‹ ", "ì…ë§", "ì¡°ê¸°ì§„í†µ", "íƒœë™", "ìœ ì‚°",
    ],

    # ë¹„ë‡¨ì˜í•™ê³¼
    "ë¹„ë‡¨ì˜í•™ê³¼": [
        "ì†Œë³€", "ë°°ë‡¨í†µ", "ì†Œë³€ ë³¼ ë•Œ",
        "ì†Œë³€ ìì£¼", "ìš”ì‹¤ê¸ˆ", "í˜ˆë‡¨", "ì†Œë³€ì— í”¼",
        "ê³ í™˜í†µì¦", "ì˜†êµ¬ë¦¬ í†µì¦", "ìš”ë¡œê²°ì„",
    ],

    # í”¼ë¶€ê³¼
    "í”¼ë¶€ê³¼": [
        "í”¼ë¶€", "ë°œì§„", "ë‘ë“œëŸ¬ê¸°", "ì—¬ë“œë¦„", "ì•„í† í”¼",
        "ìŠµì§„", "í”¼ë¶€ì—¼", "ìˆ˜í¬", "ë¬¼ì§‘", "ìˆ˜ë‘",
        "ë²Œë ˆë¬¼ë¦¼", "ê°€ë ¤ì›€", "ë‘í”¼",
    ],

    # ì •ì‹ ê±´ê°•ì˜í•™ê³¼
    "ì •ì‹ ê±´ê°•ì˜í•™ê³¼": [
        "ìš°ìš¸", "ë¬´ê¸°ë ¥", "ë¶ˆì•ˆ", "ê³µí™©", "íŒ¨ë‹‰",
        "ë¶ˆë©´", "ì ì´ ì•ˆ", "ìˆ˜ë©´ì¥ì• ",
        "ìì‚´", "ì£½ê³  ì‹¶", "í™˜ì²­", "ë§ìƒ",
    ],

    # ì¹˜ê³¼
    "ì¹˜ê³¼": [
        "ì¹˜í†µ", "ì´ê°€ ì•„í”„", "ì¶©ì¹˜", "ì‡ëª¸", "ì‡ëª¸ ë¶“",
        "ì‡ëª¸ì¶œí˜ˆ", "ì‚¬ë‘ë‹ˆ", "í„±ê´€ì ˆ",
    ],

    # ì‘ê¸‰ì˜í•™ê³¼ (ì‘ê¸‰ì‹¤ ì§í–‰)
    "ì‘ê¸‰ì˜í•™ê³¼": [
        "ì˜ì‹ ì—†", "ê¹¨ì§€ ì•Š", "ì˜ì‹ ì €í•˜",
        "í˜¸í¡ê³¤ë€", "ìˆ¨ ëª» ì‰¬", "ìˆ¨ì´ ì•ˆ",
        "ì‹¬í•œ ê°€ìŠ´í†µì¦", "ê°€ìŠ´ì´ ë„ˆë¬´",
        "ëŒ€ëŸ‰ ì¶œí˜ˆ", "í”¼ê°€ ì•ˆ ë©ˆì¶°",
        "ê²½ë ¨", "ë°œì‘", "ì „ì‹  ê²½ë ¨",
        "êµí†µì‚¬ê³ ", "ì¶”ë½", "ë¨¸ë¦¬ ë¶€ë”ª",
        "í† í˜ˆ", "í˜ˆë³€", "ê²€ì€ ë³€",
    ],
}


# ==========================================
# 2. ì‘ê¸‰ë„ í‚¤ì›Œë“œ (ê· í˜•ì¡íŒ ë²„ì „)
# ==========================================

EMERGENCY_KEYWORDS: List[str] = [
    # ğŸ”´ ì¦‰ì‹œ 119/ì‘ê¸‰ì‹¤
    "ì˜ì‹ì—†", "ê¹¨ì§€ì•Š", "ì˜ì‹ì €í•˜", "ì •ì‹ ì—†",
    "í˜¸í¡ê³¤ë€", "ìˆ¨ëª»ì‰¬", "ìˆ¨ì´ì•ˆ", "ìˆ¨ì´ë§‰í˜€", "ìˆ¨ì‰¬ê¸°í˜ë“¤",
    "ì‹¬í•œê°€ìŠ´í†µì¦", "ê°€ìŠ´ë„ˆë¬´", "ê°€ìŠ´ì°¢ì–´ì§€", "ê°€ìŠ´ì¥ì–´ì§œ",
    "ëŒ€ëŸ‰ì¶œí˜ˆ", "í”¼ì•ˆë©ˆì¶°", "í† í˜ˆ", "í”¼í† í•´",
    "ê²½ë ¨", "ë°œì‘", "ì „ì‹ ê²½ë ¨", "ëª¸ë–¨ë¦¼ì‹¬í•¨",
    "êµí†µì‚¬ê³ ", "ì¶”ë½", "ë¨¸ë¦¬ë¶€ë”ª", "ë¨¸ë¦¬ê°•í•˜ê²Œ",
    "í˜ˆë³€", "ê²€ì€ë³€", "í”¼ì„ì¸ëŒ€ë³€",
    "40ë„", "41ë„", "ê³ ì—´ì˜ì‹", "ê³ ì—´ê²½ë ¨",
    "ì‡¼í¬", "ì‹ì€ë•€ì‹¬í•¨", "ì˜ì‹ëª½ë¡±",
]

URGENT_KEYWORDS: List[str] = [
    # ğŸŸ¡ 24ì‹œê°„ ë‚´ ì§„ë£Œ (ì§„ì§œ ì‹¬í•œ ê²½ìš°ë§Œ)
    # ë°œì—´ ê´€ë ¨ - ê³ ì—´ì´ê±°ë‚˜ ì§€ì†
    "39ë„", "ê³ ì—´ê³„ì†", "ì—´ì´ì‚¬í˜", "ì—´ì´ì´í‹€ì´ìƒ", "ì—´ì•ˆë–¨ì–´ì ¸",
    # í†µì¦ ê´€ë ¨ - ì°¸ê¸° í˜ë“  ìˆ˜ì¤€
    "ë„ˆë¬´ë„ˆë¬´ì•„íŒŒ", "ëª»ì°¸ê² ", "ê²¬ë”œìˆ˜ì—†", "ê·¹ì‹¬í•œí†µì¦", "ì¹¼ë¡œë² ì´ëŠ”",
    # ì†Œí™”ê¸° - ì‹¬ê°í•œ íƒˆìˆ˜ ìœ„í—˜
    "í•˜ë£¨ì¢…ì¼í† ", "ê³„ì†í† í•´", "ë¬¼ë„ëª»ë¨¹", "í† ì‚¬ë¬¼ì—í”¼",
    "ì„¤ì‚¬ì‹¬í•¨", "í”¼ì„ì¸ì„¤ì‚¬", "í•˜ë£¨ì¢…ì¼ì„¤ì‚¬",
    # í˜¸í¡ - í˜ë“¤ì§€ë§Œ ì‘ê¸‰ì€ ì•„ë‹˜
    "ìˆ¨ì´ì¢€ì°¨", "ìˆ¨ê°€ë¹ ", "í˜¸í¡ë¹ ë¦„",
    # ì•Œë ˆë¥´ê¸° - ì „ì‹  ì¦ìƒ
    "ì˜¨ëª¸ë‘ë“œëŸ¬ê¸°", "ì „ì‹ ë‘ë“œëŸ¬ê¸°", "ì–¼êµ´ë¶€ìŒ",
    # ì™¸ìƒ - ì‹¬ê°í•œ ë¶€ìƒ
    "ë¼ˆê°€ë³´ì—¬", "ìƒì²˜ê¹Š", "ë¶€ëŸ¬ì§„ê²ƒê°™", "ê³¨ì ˆì˜ì‹¬",
    # ë°°ë‡¨ - ì‹¬ê°í•œ ë¬¸ì œ
    "ì†Œë³€ì•ˆë‚˜ì™€", "ì†Œë³€ëª»ë´", "í˜ˆë‡¨ì‹¬í•¨",
    # ëª© - ì‘ê¸‰ ê°€ëŠ¥ì„±
    "ëª©ë¶“ê³ ìˆ¨í˜ë“¤", "ì¹¨ì‚¼í‚¤ê¸°í˜ë“¤",
]

OBSERVATION_KEYWORDS: List[str] = [
    # ğŸŸ¢ ìê°€ ê´€ì°° (ì¼ë°˜ì ì¸ ê²½ë¯¸í•œ ì¦ìƒ)
    # ë°œì—´
    "37ë„", "ë¯¸ì—´", "ì—´ì¡°ê¸ˆ",
    # ê°ê¸°
    "ì½§ë¬¼", "ì½”ë§‰í˜", "ê¸°ì¹¨ì¡°ê¸ˆ", "ì¬ì±„ê¸°",
    # í†µì¦ - ê²½ë¯¸
    "ì¡°ê¸ˆì•„íŒŒ", "ì•½ê°„ì•„íŒŒ", "ì‚´ì§ì•„íŒŒ",
    # ì†Œí™”ê¸° - ê²½ë¯¸
    "ì†ì¢€ì•ˆì¢‹", "ì†Œí™”ì•ˆë¼", "ë°°ì¢€ë¶ˆí¸",
    # í”¼ë¡œ
    "í”¼ê³¤", "ëª¸ì‚´ê¸°ìš´",
]


# ==========================================
# 3. í—¬í¼ í•¨ìˆ˜
# ==========================================

def normalize_text(text: str) -> str:
    """í…ìŠ¤íŠ¸ ì •ê·œí™”: ê³µë°± ì œê±° + ì†Œë¬¸ì"""
    return text.replace(" ", "").lower()


def classify_department(text: str) -> Dict[str, Any]:
    """
    ì¦ìƒ í…ìŠ¤íŠ¸ â†’ ì§„ë£Œê³¼ ë¶„ë¥˜
    """
    norm = normalize_text(text)
    dept_scores: Dict[str, int] = {}

    # í‚¤ì›Œë“œ ë§¤ì¹­
    for dept, keywords in DEPARTMENT_KEYWORDS.items():
        score = sum(1 for kw in keywords if normalize_text(kw) in norm)
        if score > 0:
            dept_scores[dept] = score

    if not dept_scores:
        return {
            "primary": "ë‚´ê³¼/ê°€ì •ì˜í•™ê³¼",
            "candidates": [],
            "confidence": 0.3,
            "reason": "ëª…í™•í•œ í‚¤ì›Œë“œ ì—†ìŒ. 1ì°¨ ì§„ë£Œ ê¶Œì¥"
        }

    # ìµœë‹¤ ë§¤ì¹­ ì§„ë£Œê³¼
    primary = max(dept_scores, key=dept_scores.get)
    
    # í›„ë³´ ì§„ë£Œê³¼
    sorted_depts = sorted(dept_scores.items(), key=lambda x: x[1], reverse=True)
    candidates = [d for d, _ in sorted_depts if d != primary][:3]
    
    # ì‹ ë¢°ë„
    confidence = min(dept_scores[primary] / 3.0, 1.0)

    return {
        "primary": primary,
        "candidates": candidates,
        "confidence": round(confidence, 2),
        "reason": f"'{primary}' ê´€ë ¨ í‘œí˜„ {dept_scores[primary]}ê°œ í¬í•¨"
    }


def assess_urgency(text: str) -> Dict[str, Any]:
    """
    ì‘ê¸‰ë„ í‰ê°€: emergency / urgent / observation
    
    ê· í˜•ì¡íŒ ì›ì¹™:
    - ì‘ê¸‰: ì¦‰ì‹œ ìƒëª… ìœ„í—˜
    - ì™¸ë˜: ì‹¬í•œ ì¦ìƒì´ê±°ë‚˜ ì§€ì†ë˜ëŠ” ê²½ìš°
    - ê´€ì°°: ì¼ë°˜ì ì¸ ê²½ë¯¸í•œ ì¦ìƒ
    """
    norm = normalize_text(text)

    # ğŸ”´ ì‘ê¸‰ (ì¦‰ì‹œ 119/ì‘ê¸‰ì‹¤)
    for kw in EMERGENCY_KEYWORDS:
        if kw in norm:
            return {
                "level": "emergency",
                "label": "ğŸ”´ ì‘ê¸‰ì‹¤ ì¦‰ì‹œ",
                "reason": f"ìœ„í—˜ ì¦ìƒ ê°ì§€: '{kw}'",
                "action": "ì§€ì²´í•˜ì§€ ë§ê³  119 ë˜ëŠ” ê°€ì¥ ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤ë¡œ ì´ë™í•˜ì„¸ìš”."
            }

    # ğŸŸ¡ ê¸´ê¸‰ (24ì‹œê°„ ë‚´) - ì‹¬í•œ ê²½ìš°ë§Œ
    for kw in URGENT_KEYWORDS:
        if kw in norm:
            return {
                "level": "urgent",
                "label": "ğŸŸ¡ ë¹ ë¥¸ ì§„ë£Œ í•„ìš”",
                "reason": f"ì£¼ì˜ ì¦ìƒ ê°ì§€: '{kw}'",
                "action": "ê°€ëŠ¥í•˜ë©´ ì˜¤ëŠ˜ ì•ˆì—, ëŠ¦ì–´ë„ 24ì‹œê°„ ë‚´ ë³‘ì› ë°©ë¬¸ì„ ê¶Œì¥í•©ë‹ˆë‹¤."
            }

    # ğŸŸ¢ ìê°€ ê´€ì°° í‚¤ì›Œë“œ ì²´í¬
    for kw in OBSERVATION_KEYWORDS:
        if kw in norm:
            return {
                "level": "observation",
                "label": "ğŸŸ¢ ìê°€ ê´€ì°°",
                "reason": f"ê²½ë¯¸í•œ ì¦ìƒ: '{kw}'",
                "action": "ì¦ìƒì„ ê´€ì°°í•˜ë©´ì„œ, ì•…í™”ë˜ê±°ë‚˜ ì˜¤ë˜ ì§€ì†ë˜ë©´ ì™¸ë˜ ì§„ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”."
            }
    
    # ê¸°ë³¸ íŒë‹¨ ë¡œì§
    # 1) ë‹¨ìˆœ ëª…ì‚¬ë§Œ (ì˜ˆ: "ë‘í†µ", "ë³µí†µ", "ì—´")
    # 2) "~ìš”", "ìˆì–´ìš”" ê°™ì€ ê¸°ë³¸ í‘œí˜„
    # â†’ ìê°€ê´€ì°°
    
    simple_symptoms = [
        "ë‘í†µ", "ë¨¸ë¦¬ì•„íŒŒ", "ë¨¸ë¦¬ê°€ì•„íŒŒ",
        "ë³µí†µ", "ë°°ì•„íŒŒ", "ë°°ê°€ì•„íŒŒ",
        "ì—´", "ë°œì—´", "ì—´ë‚˜",
        "ê¸°ì¹¨", "ì½§ë¬¼", "ì½”ë§‰í˜",
        "êµ¬í† ", "í† í•´", "ì„¤ì‚¬",
        "í”¼ê³¤", "ëª¸ì‚´", "ë¬´ê¸°ë ¥",
    ]
    
    # ì‹¬ê°ë„ë¥¼ ë†’ì´ëŠ” í‘œí˜„
    severe_modifiers = [
        "ë„ˆë¬´", "ë§ì´", "ì‹¬í•˜ê²Œ", "ê³„ì†", "ìê¾¸",
        "ëª»", "ì•ˆ", "í˜ë“¤", "ì‹¬ê°",
    ]
    
    has_simple_symptom = any(s in norm for s in simple_symptoms)
    has_severe = any(m in norm for m in severe_modifiers)
    
    # ë‹¨ìˆœ ì¦ìƒë§Œ ìˆê³  ì‹¬ê°ë„ í‘œí˜„ì´ ì—†ìœ¼ë©´ â†’ ìê°€ê´€ì°°
    if has_simple_symptom and not has_severe:
        return {
            "level": "observation",
            "label": "ğŸŸ¢ ìê°€ ê´€ì°°",
            "reason": "ì¼ë°˜ì ì¸ ì¦ìƒ",
            "action": "ì¦ìƒì„ ê´€ì°°í•˜ë©´ì„œ, ì•…í™”ë˜ê±°ë‚˜ ì˜¤ë˜ ì§€ì†ë˜ë©´ ë³‘ì› ë°©ë¬¸ì„ ê³ ë ¤í•˜ì„¸ìš”."
        }
    
    # ì‹¬ê°ë„ í‘œí˜„ì´ ìˆìœ¼ë©´ â†’ ì™¸ë˜ì§„ë£Œ
    if has_severe:
        return {
            "level": "urgent",
            "label": "ğŸŸ¡ ì™¸ë˜ ì§„ë£Œ ê¶Œì¥",
            "reason": "ì¦ìƒì˜ ê°•ë„ê°€ ê±±ì •ë¨",
            "action": "ì¦ìƒì´ ì§€ì†ë˜ê±°ë‚˜ ì•…í™”ë˜ë©´ ë³‘ì› ë°©ë¬¸ì„ ê¶Œì¥í•©ë‹ˆë‹¤."
        }
    
    # ê¸°ë³¸ê°’: ìê°€ê´€ì°° (ê· í˜•ì¡íŒ ì ‘ê·¼)
    return {
        "level": "observation",
        "label": "ğŸŸ¢ ìê°€ ê´€ì°°",
        "reason": "ê²½ë¯¸í•œ ìˆ˜ì¤€ìœ¼ë¡œ íŒë‹¨ë¨",
        "action": "ì¦ìƒì„ ê´€ì°°í•˜ê³ , ì•…í™”ë˜ê±°ë‚˜ 48ì‹œê°„ ì´ìƒ ì§€ì†ë˜ë©´ ë³‘ì› ì§„ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”."
    }


def route_patient(text: str) -> Dict[str, Any]:
    """
    í†µí•© ë¼ìš°íŒ…: ì§„ë£Œê³¼ + ì‘ê¸‰ë„ í•œ ë²ˆì—
    """
    urgency = assess_urgency(text)
    dept_info = classify_department(text)

    # ì‘ê¸‰ ìƒí™©ì´ë©´ ì§„ë£Œê³¼ë³´ë‹¤ ì‘ê¸‰ì‹¤ ìš°ì„ 
    if urgency["level"] == "emergency":
        primary_dept = "ì‘ê¸‰ì˜í•™ê³¼(ì‘ê¸‰ì‹¤)"
    else:
        primary_dept = dept_info["primary"]

    return {
        "primary_department": primary_dept,
        "department_candidates": dept_info["candidates"],
        "department_confidence": dept_info["confidence"],
        "department_reason": dept_info["reason"],
        "urgency": urgency,
    }