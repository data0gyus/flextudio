from typing import Dict, List, Any


# ==========================================
# 1. ì§„ë£Œê³¼ë³„ í‚¤ì›Œë“œ ë§¤í•‘
# ==========================================

DEPARTMENT_KEYWORDS: Dict[str, List[str]] = {
    # ì†Œì•„ì²­ì†Œë…„ê³¼ (ìµœìš°ì„ )
    "ì†Œì•„ì²­ì†Œë…„ê³¼": [
        "ì•„ì´", "ì•„ê¸°", "ì†Œì•„", "ì–´ë¦°ì´", "ìœ ì•„", "ì‹ ìƒì•„", "ì˜ì•„",
        "ìƒí›„", "ê°œì›”", "ëŒ", "ë¯¸ì·¨í•™", "ì´ˆë“±í•™ìƒ",
        "ì—´", "ê³ ì—´", "ë°œì—´", "ê°ê¸°", "ì½§ë¬¼", "ê¸°ì¹¨",
        "êµ¬í† ", "ì„¤ì‚¬", "ì—´ì´ ì•ˆ ë–¨ì–´", "ê²½ë ¨", "ë°œì§„",
        "ì˜ˆë°©ì ‘ì¢…", "ì„±ì¥", "ë°œë‹¬",
    ],

    # ì•ˆê³¼
    "ì•ˆê³¼": [
        "ëˆˆ", "ì‹œë ¥", "ì‹œì•¼", "ì¶©í˜ˆ", "ëˆˆë¬¼", "ëˆˆê³±", "ë‹¤ë˜ë¼",
        "ëˆˆêº¼í’€", "ëˆˆë¶€ì‹¬", "ì´ë¬¼ê°", "ëˆˆì´ ë”°ê°‘", "ëˆˆì´ ì•„í”„",
        "ê²°ë§‰ì—¼", "ê°ë§‰", "ì‹œì•¼ íë¦¼",
    ],

    # ì´ë¹„ì¸í›„ê³¼
    "ì´ë¹„ì¸í›„ê³¼": [
        "ì½”ë§‰í˜", "ì½§ë¬¼", "ë¹„ì—¼", "ì¶•ë†ì¦", "ì½”í”¼",
        "ê·€í†µì¦", "ê·€ê°€ ì•„í”„", "ì´ëª…", "ì¤‘ì´ì—¼", "ë‚œì²­",
        "ëª©ì•„í””", "ëª©ì´ ì•„í”„", "ì¸í›„í†µ", "í¸ë„", "ì‰°ëª©ì†Œë¦¬",
        "ëª©ì´ ë”°ê°‘", "ëª©ì´ ë¶“", "ì¹¨ ì‚¼í‚¤ê¸° í˜ë“¤",
    ],

    # í˜¸í¡ê¸°ë‚´ê³¼
    "í˜¸í¡ê¸°ë‚´ê³¼": [
        "ê¸°ì¹¨", "ê°€ë˜", "ìˆ¨ì´ ì°¬", "í˜¸í¡ê³¤ë€", "ìˆ¨ì‰¬ê¸° í˜ë“¤",
        "ìŒ•ìŒ•", "ì²œì‹", "íë ´", "ê°€ìŠ´ì´ ë‹µë‹µ", "ê¸°ê´€ì§€ì—¼",
    ],

    # ìˆœí™˜ê¸°ë‚´ê³¼ (ì‹¬ì¥/í˜ˆê´€)
    "ìˆœí™˜ê¸°ë‚´ê³¼": [
        "ê°€ìŠ´í†µì¦", "ì‹¬ì¥", "ë‘ê·¼ê±°ë¦¼", "ë¶€ì •ë§¥",
        "ê°€ìŠ´ì´ ì¥ì–´ì§œ", "ì¡°ì´ëŠ” ëŠë‚Œ",
        "í˜ˆì••", "ê³ í˜ˆì••", "ì €í˜ˆì••", "ë‹¤ë¦¬ ë¶€ì¢…",
    ],

    # ì†Œí™”ê¸°ë‚´ê³¼
    "ì†Œí™”ê¸°ë‚´ê³¼": [
        "ì†ì“°ë¦¼", "ëª…ì¹˜í†µì¦", "ì†Œí™”ë¶ˆëŸ‰", "ì²´í•œ",
        "êµ¬ì—­", "êµ¬í† ", "ë³µí†µ", "ë°°ì•„í””", "ë°° í†µì¦",
        "ë³€ë¹„", "ì„¤ì‚¬", "í˜ˆë³€", "ê²€ì€ ë³€", "ì†ì´ ë”ë¶€ë£©",
        "ìœ„ì—¼", "ì¥ì—¼",
    ],

    # ì •í˜•ì™¸ê³¼
    "ì •í˜•ì™¸ê³¼": [
        "ê³¨ì ˆ", "ë¶€ëŸ¬ì¡Œ", "ì‚ì—ˆ", "ì‚ë—", "ì—¼ì¢Œ",
        "ê´€ì ˆí†µ", "ë¬´ë¦", "ë°œëª©", "í—ˆë¦¬í†µì¦", "í—ˆë¦¬ê°€ ì•„í”„",
        "ëª©ë””ìŠ¤í¬", "ì–´ê¹¨í†µì¦", "ê·¼ìœ¡í†µ", "íƒ€ë°•ìƒ",
        "ë„˜ì–´ì ¸ì„œ", "ë¶€ë”ªí˜”",
    ],

    # ì‹ ê²½ê³¼/ì‹ ê²½ì™¸ê³¼
    "ì‹ ê²½ê³¼": [
        "ë‘í†µ", "í¸ë‘í†µ", "ì–´ì§€ëŸ¼", "ì–´ì§€ëŸ¬ì›€", "ì‹¤ì‹ ",
        "ë§ˆë¹„", "í˜ì´ ì•ˆ", "ê°ê° ë‘”í•¨", "ì†ë°œì €ë¦¼",
        "ë§ì´ ì–´ëˆŒ", "ë°œìŒ ì–´ëˆŒ", "ì‹œì•¼ì¥ì• ",
        "ê²½ë ¨", "ë°œì‘", "ë–¨ë¦¼", "ì˜ì‹ ì €í•˜",
    ],

    # ì‚°ë¶€ì¸ê³¼
    "ì‚°ë¶€ì¸ê³¼": [
        "ìƒë¦¬í†µ", "ìƒë¦¬ë¶ˆìˆœ", "ì§ˆì¶œí˜ˆ", "ë¶ˆê·œì¹™í•œ ìƒë¦¬",
        "ì§ˆë¶„ë¹„ë¬¼", "ëƒ‰", "ê³¨ë°˜í†µ", "í•˜ë³µë¶€í†µì¦",
        "ì„ì‹ ", "ì…ë§", "ì¡°ê¸°ì§„í†µ", "íƒœë™", "ìœ ì‚°",
    ],

    # ë¹„ë‡¨ì˜í•™ê³¼
    "ë¹„ë‡¨ì˜í•™ê³¼": [
        "ì†Œë³€", "ë°°ë‡¨í†µ", "ì†Œë³€ ë³¼ ë•Œ",
        "ì†Œë³€ ìì£¼", "ìš”ì‹¤ê¸ˆ", "í˜ˆë‡¨", "ì†Œë³€ì— í”¼",
        "ê³ í™˜í†µì¦", "ì˜†êµ¬ë¦¬ í†µì¦", "ìš”ë¡œê²°ì„",
    ],

    # í”¼ë¶€ê³¼
    "í”¼ë¶€ê³¼": [
        "í”¼ë¶€", "ë°œì§„", "ë‘ë“œëŸ¬ê¸°", "ì—¬ë“œë¦„", "ì•„í† í”¼",
        "ìŠµì§„", "í”¼ë¶€ì—¼", "ìˆ˜í¬", "ë¬¼ì§‘", "ìˆ˜ë‘",
        "ë²Œë ˆë¬¼ë¦¼", "ê°€ë ¤ì›€", "ë‘í”¼",
    ],

    # ì •ì‹ ê±´ê°•ì˜í•™ê³¼
    "ì •ì‹ ê±´ê°•ì˜í•™ê³¼": [
        "ìš°ìš¸", "ë¬´ê¸°ë ¥", "ë¶ˆì•ˆ", "ê³µí™©", "íŒ¨ë‹‰",
        "ë¶ˆë©´", "ì ì´ ì•ˆ", "ìˆ˜ë©´ì¥ì• ",
        "ìì‚´", "ì£½ê³  ì‹¶", "í™˜ì²­", "ë§ìƒ",
    ],

    # ì¹˜ê³¼
    "ì¹˜ê³¼": [
        "ì¹˜í†µ", "ì´ê°€ ì•„í”„", "ì¶©ì¹˜", "ì‡ëª¸", "ì‡ëª¸ ë¶“",
        "ì‡ëª¸ì¶œí˜ˆ", "ì‚¬ë‘ë‹ˆ", "í„±ê´€ì ˆ",
    ],

    # ì‘ê¸‰ì˜í•™ê³¼ (ì‘ê¸‰ì‹¤ ì§í–‰)
    "ì‘ê¸‰ì˜í•™ê³¼": [
        "ì˜ì‹ ì—†", "ê¹¨ì§€ ì•Š", "ì˜ì‹ ì €í•˜",
        "í˜¸í¡ê³¤ë€", "ìˆ¨ ëª» ì‰¬", "ìˆ¨ì´ ì•ˆ",
        "ì‹¬í•œ ê°€ìŠ´í†µì¦", "ê°€ìŠ´ì´ ë„ˆë¬´",
        "ëŒ€ëŸ‰ ì¶œí˜ˆ", "í”¼ê°€ ì•ˆ ë©ˆì¶°",
        "ê²½ë ¨", "ë°œì‘", "ì „ì‹  ê²½ë ¨",
        "êµí†µì‚¬ê³ ", "ì¶”ë½", "ë¨¸ë¦¬ ë¶€ë”ª",
        "í† í˜ˆ", "í˜ˆë³€", "ê²€ì€ ë³€",
    ],
}


# ==========================================
# 2. ì‘ê¸‰ë„ í‚¤ì›Œë“œ
# ==========================================

EMERGENCY_KEYWORDS: List[str] = [
    # ğŸ”´ ì¦‰ì‹œ 119/ì‘ê¸‰ì‹¤
    "ì˜ì‹ì—†", "ê¹¨ì§€ì•Š", "ì˜ì‹ì €í•˜",
    "í˜¸í¡ê³¤ë€", "ìˆ¨ëª»ì‰¬", "ìˆ¨ì´ì•ˆ",
    "ì‹¬í•œê°€ìŠ´í†µì¦", "ê°€ìŠ´ë„ˆë¬´",
    "ëŒ€ëŸ‰ì¶œí˜ˆ", "í”¼ì•ˆë©ˆì¶°", "í† í˜ˆ",
    "ê²½ë ¨", "ë°œì‘", "ì „ì‹ ê²½ë ¨",
    "êµí†µì‚¬ê³ ", "ì¶”ë½", "ë¨¸ë¦¬ë¶€ë”ª",
    "í˜ˆë³€", "ê²€ì€ë³€",
    "40ë„", "ê³ ì—´ì˜ì‹",
]

URGENT_KEYWORDS: List[str] = [
    # ğŸŸ¡ 24ì‹œê°„ ë‚´ ì§„ë£Œ
    "39ë„", "ê³ ì—´", "ì—´ì•ˆë–¨ì–´",
    "ê³„ì†í† ", "êµ¬í† ê³„ì†", "ì„¤ì‚¬ê³„ì†",
    "í˜¸í¡ë¹ ë¦„", "ì†Œë³€ì•ˆë‚˜", "ì†Œë³€ëª»",
    "ì‹¬í•œë³µí†µ", "ì¹¼ë¡œë² ì´ëŠ”",
    "ëª©ë¶“", "ìŒì‹ëª»ë¨¹",
]

OBSERVATION_KEYWORDS: List[str] = [
    # ğŸŸ¢ ìê°€ ê´€ì°°
    "ì½§ë¬¼", "ê¸°ì¹¨", "ëª©ì¡°ê¸ˆ", "ì‚´ì§",
    "ë¯¸ì—´", "ë‘í†µì¡°ê¸ˆ",
]


# ==========================================
# 3. í—¬í¼ í•¨ìˆ˜
# ==========================================

def normalize_text(text: str) -> str:
    """í…ìŠ¤íŠ¸ ì •ê·œí™”: ê³µë°± ì œê±° + ì†Œë¬¸ì"""
    return text.replace(" ", "").lower()


def classify_department(text: str) -> Dict[str, Any]:
    """
    ì¦ìƒ í…ìŠ¤íŠ¸ â†’ ì§„ë£Œê³¼ ë¶„ë¥˜
    
    Returns:
        {
            "primary": "ì†Œì•„ì²­ì†Œë…„ê³¼",
            "candidates": ["ì´ë¹„ì¸í›„ê³¼", "í˜¸í¡ê¸°ë‚´ê³¼"],
            "confidence": 0.8,
            "reason": "..."
        }
    """
    norm = normalize_text(text)
    dept_scores: Dict[str, int] = {}

    # í‚¤ì›Œë“œ ë§¤ì¹­
    for dept, keywords in DEPARTMENT_KEYWORDS.items():
        score = sum(1 for kw in keywords if normalize_text(kw) in norm)
        if score > 0:
            dept_scores[dept] = score

    if not dept_scores:
        return {
            "primary": "ì†Œì•„ì²­ì†Œë…„ê³¼/ë‚´ê³¼",
            "candidates": [],
            "confidence": 0.3,
            "reason": "ëª…í™•í•œ í‚¤ì›Œë“œ ì—†ìŒ. 1ì°¨ ì§„ë£Œ(ì†Œì•„ê³¼/ë‚´ê³¼) ê¶Œì¥"
        }

    # ìµœë‹¤ ë§¤ì¹­ ì§„ë£Œê³¼
    primary = max(dept_scores, key=dept_scores.get)
    
    # í›„ë³´ ì§„ë£Œê³¼ (ìƒìœ„ 3ê°œ)
    sorted_depts = sorted(dept_scores.items(), key=lambda x: x[1], reverse=True)
    candidates = [d for d, _ in sorted_depts if d != primary][:3]
    
    # ì‹ ë¢°ë„ ê³„ì‚°
    confidence = min(dept_scores[primary] / 3.0, 1.0)

    return {
        "primary": primary,
        "candidates": candidates,
        "confidence": round(confidence, 2),
        "reason": f"'{primary}' ê´€ë ¨ í‘œí˜„ {dept_scores[primary]}ê°œ í¬í•¨"
    }


def assess_urgency(text: str) -> Dict[str, Any]:
    """
    ì‘ê¸‰ë„ í‰ê°€: emergency / urgent / observation
    
    Returns:
        {
            "level": "emergency",
            "label": "ğŸ”´ ì‘ê¸‰ì‹¤ ì¦‰ì‹œ",
            "reason": "...",
            "action": "..."
        }
    """
    norm = normalize_text(text)

    # ğŸ”´ ì‘ê¸‰ (ì¦‰ì‹œ 119/ì‘ê¸‰ì‹¤)
    for kw in EMERGENCY_KEYWORDS:
        if kw in norm:
            return {
                "level": "emergency",
                "label": "ğŸ”´ ì‘ê¸‰ì‹¤ ì¦‰ì‹œ",
                "reason": f"ìœ„í—˜ ì¦ìƒ ê°ì§€: '{kw}'",
                "action": "ì§€ì²´í•˜ì§€ ë§ê³  119 ë˜ëŠ” ê°€ì¥ ê°€ê¹Œìš´ ì‘ê¸‰ì‹¤ë¡œ ì´ë™í•˜ì„¸ìš”."
            }

    # ğŸŸ¡ ê¸´ê¸‰ (24ì‹œê°„ ë‚´)
    for kw in URGENT_KEYWORDS:
        if kw in norm:
            return {
                "level": "urgent",
                "label": "ğŸŸ¡ ë¹ ë¥¸ ì§„ë£Œ í•„ìš”",
                "reason": f"ì£¼ì˜ ì¦ìƒ ê°ì§€: '{kw}'",
                "action": "ê°€ëŠ¥í•˜ë©´ ì˜¤ëŠ˜ ì•ˆì—, ëŠ¦ì–´ë„ 24ì‹œê°„ ë‚´ ë³‘ì› ë°©ë¬¸ì„ ê¶Œì¥í•©ë‹ˆë‹¤."
            }

    # ğŸŸ¢ ìê°€ ê´€ì°°
    for kw in OBSERVATION_KEYWORDS:
        if kw in norm:
            return {
                "level": "observation",
                "label": "ğŸŸ¢ ìê°€ ê´€ì°°",
                "reason": f"ê²½ë¯¸í•œ ì¦ìƒ: '{kw}'",
                "action": "ì¦ìƒì„ ê´€ì°°í•˜ë©´ì„œ, ì•…í™”ë˜ê±°ë‚˜ ì˜¤ë˜ ì§€ì†ë˜ë©´ ì™¸ë˜ ì§„ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”."
            }

    # ê¸°ë³¸ê°’: ê´€ì°° (ë³´ìˆ˜ì )
    return {
        "level": "observation",
        "label": "ğŸŸ¢ ìê°€ ê´€ì°°",
        "reason": "ëª…í™•í•œ ìœ„í—˜ ì‹ í˜¸ ì—†ìŒ",
        "action": "ì¦ìƒì„ ê´€ì°°í•˜ê³ , ê±±ì •ë˜ë©´ ë³‘ì› ì§„ë£Œë¥¼ ë°›ìœ¼ì„¸ìš”."
    }


def route_patient(text: str) -> Dict[str, Any]:
    """
    í†µí•© ë¼ìš°íŒ…: ì§„ë£Œê³¼ + ì‘ê¸‰ë„ í•œ ë²ˆì—
    
    Returns:
        {
            "primary_department": "ì†Œì•„ì²­ì†Œë…„ê³¼",
            "department_candidates": ["ì´ë¹„ì¸í›„ê³¼"],
            "department_confidence": 0.8,
            "urgency": {...},
        }
    """
    urgency = assess_urgency(text)
    dept_info = classify_department(text)

    # ì‘ê¸‰ ìƒí™©ì´ë©´ ì§„ë£Œê³¼ë³´ë‹¤ ì‘ê¸‰ì‹¤ ìš°ì„ 
    if urgency["level"] == "emergency":
        primary_dept = "ì‘ê¸‰ì˜í•™ê³¼(ì‘ê¸‰ì‹¤)"
    else:
        primary_dept = dept_info["primary"]

    return {
        "primary_department": primary_dept,
        "department_candidates": dept_info["candidates"],
        "department_confidence": dept_info["confidence"],
        "department_reason": dept_info["reason"],
        "urgency": urgency,
    }

